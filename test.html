<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https:;">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.ethers.io/lib/ethers-5.5.umd.min.js"></script>
  </head>
  <body>
    <button onclick="login()">Login with MetaMask</button>
    <script>
      const axios = window.axios;
      const ethers = window.ethers;

      let url = "https://api.lens.dev/";
      let config = {
        headers: {
          "referer": "https://claim.lens.xyz/",
          "origin": "https://claim.lens.xyz",
          "content-type": "application/json",
          "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/102.0.0.0 Safari/537.36",
        },
      };

      let getMessage = async (address) => {
        let payload = {
          variables: {
            request: {
              address: `${address}`,
            },
          },
          query: "query ($request: ChallengeRequest!) {\n  challenge(request: $request) {\n    text\n    __typename\n  }\n}",
        };
        try {
          let res = await axios.post(url, payload, config);
          return res.data.data.challenge.text;
        } catch (err) {
          console.log(`${address}---获取签名信息失败: ${err}`);
          return false;
        }
      };

      let sendLogin = async (address, signature) => {
        let payload = {
          variables: {
            request: {
              address: `${address}`,
              signature: `${signature}`,
            },
          },
          query: "mutation ($request: SignedAuthChallenge!) {\n  authenticate(request: $request) {\n    accessToken\n    refreshToken\n    __typename\n  }\n}",
        };
        try {
          let res = await axios.post(url, payload, config);
          return {
            walletAddress: address,
            accessToken: res.data.data.authenticate.accessToken,
            refreshToken: res.data.data.authenticate.refreshToken,
          };
        } catch (err) {
          console.log(`${address}---登录失败: ${err}`);
          return false;
        }
      };

      function isMetaMaskInstalled() {
          return typeof window.ethereum !== "undefined" && window.ethereum.isMetaMask;
      }

      async function getAccount() {
          if (isMetaMaskInstalled()) {
              try {
                  const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
                  return accounts[0];
              } catch (error) {
                  console.error("User rejected request:", error);
                  return null;
              }
          } else {
                 console.error("MetaMask not detected.");
                 return null;
          }
      }

      async function login() {
        const account = await getAccount();
        if (account) {
          const message = await getMessage(account);
          const signature = await window.ethereum.request({
            method: "personal_sign",
            params: [message, account],
          });
          const result = await sendLogin(account, signature);
          console.log(result);
        } else {
          console.error("No account found");
        }
      }
    </script>
  </body>
</html>
